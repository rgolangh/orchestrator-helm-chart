{{- $ns := .Values.global.orchestrator.namespace }}
{{ if .Values.global.orchestrator.devmode }}
{{- $namespace := (lookup "v1" "Namespace" "" $ns) }}
{{- if $namespace }}
# Namespace exist, do nothing.
{{- else }}
apiVersion: v1
kind: Namespace
metadata:
  name: {{ $ns }}
{{- end }}
---  
apiVersion: sonataflow.org/v1alpha08
kind: SonataFlowPlatform
metadata:
  name: sonataflow-platform
  namespace: {{ $ns }}
spec:
  build:
    template:
      resources:
        requests:
          memory: {{ .Values.global.orchestrator.sonataPlatform.resources.requests.memory }}
          cpu: {{ .Values.global.orchestrator.sonataPlatform.resources.requests.cpu }}
        limits:
          memory: {{ .Values.global.orchestrator.sonataPlatform.resources.limits.memory }}
          cpu: {{ .Values.global.orchestrator.sonataPlatform.resources.limits.cpu }}
  services:
    dataIndex:
      enabled: true
    jobService:
      enabled: true
{{ else }}
apiVersion: sonataflow.org/v1alpha08
kind: SonataFlowPlatform
metadata:
  name: sonataflow-platform
  namespace: {{ $ns }}
spec:
  build:
    template:
      resources:
        requests:
          memory: {{ .Values.global.orchestrator.sonataPlatform.resources.requests.memory }}
          cpu: {{ .Values.global.orchestrator.sonataPlatform.resources.requests.cpu }}
        limits:
          memory: {{ .Values.global.orchestrator.sonataPlatform.resources.limits.memory }}
          cpu: {{ .Values.global.orchestrator.sonataPlatform.resources.limits.cpu }}
  services:
    dataIndex:
      enabled: true
      podTemplate:
        container:
          image: {{ .Values.global.orchestrator.sonataPlatform.dataIndex.image }} 
      persistence:
        postgresql:
          secretRef:
            name: {{ .Values.global.postgres.authSecret.name }}
            userKey: {{ .Values.global.postgres.authSecret.userKey }}
            passwordKey: {{ .Values.global.postgres.authSecret.passwordKey }}
          serviceRef:
            name: {{ .Values.global.postgres.serviceName }}
            namespace: {{ .Values.global.postgres.serviceNamespace }}
    jobService:
      enabled: true
      podTemplate:
        container:
          image: {{ .Values.global.orchestrator.sonataPlatform.jobService.image }} 
      persistence:
        postgresql:
          secretRef:
            name: {{ .Values.global.postgres.authSecret.name }}
            userKey: {{ .Values.global.postgres.authSecret.userKey }}
            passwordKey: {{ .Values.global.postgres.authSecret.passwordKey }}
          serviceRef:
            name: {{ .Values.global.postgres.serviceName }}
            namespace: {{ .Values.global.postgres.serviceNamespace }}
{{ end }}            
